<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/map.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/map-styles.css' %}">
   <title>Google Maps Integration</title>

   <style>
       body, html {
           height: 100%;
           margin: 0;
           padding: 0;
           font-family: Arial, sans-serif;
       }

       .container {
           display: flex;
           height: calc(100% - 60px);
       }
       #map {
           flex: 6;
           height: 100%;
       }
       .search-panel {
           flex: 4;
           height: 100%;
           overflow-y: auto;
           padding: 20px;
           box-sizing: border-box;
           background-color: #f8f8f8;
       }
       .search-input {
           width: 100%;
           padding: 10px;
           margin-bottom: 10px;
           box-sizing: border-box;
       }
       .restaurant-card {
           cursor: pointer;
           margin-bottom: 10px;
           padding: 10px;
           border: 1px solid #ddd;
           border-radius: 4px;
           background-color: white;
           transition: all 0.3s ease;
       }
       .restaurant-card img {
           width: 80px;
           height: 80px;
           object-fit: cover;
           float: right;
           margin-left: 10px;
       }
       .popup {
           display: none;
           position: fixed;
           left: 50%;
           top: 50%;
           transform: translate(-50%, -50%);
           background-color: white;
           padding: 20px;
           border-radius: 5px;
           box-shadow: 0 2px 10px rgba(0,0,0,0.2);
           z-index: 1000;
           max-width: 80%;
           max-height: 80%;
           overflow-y: auto;
       }
       .popup-close {
           position: absolute;
           right: 10px;
           top: 10px;
           cursor: pointer;
           font-size: 20px;
       }
       .popup-content {
           cursor: pointer;
       }
       .highlighted-card {
           border: 2px solid #007bff;
           box-shadow: 0 0 10px rgba(0,123,255,0.5);
       }
       .user-controls {
           position: absolute;
           top: 10px;
           right: 20px;
           display: flex;
           gap: 10px;
       }
       .user-controls a {
           padding: 5px 10px;
           background-color: #007bff;
           color: white;
           text-decoration: none;
           border-radius: 3px;
       }
       .user-greeting {
           position: absolute;
           top: 10px;
           left: 20px;
           font-size: 14px;
       }
       #favorites {
           list-style-type: none;
           padding: 0;
       }
       #favorites li {
           margin-bottom: 5px;
       }
   </style>

   <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places" async defer></script>
   <script type="text/javascript">
       let map;
       let service;
       let infoWindow;
       let markers = [];
       let favorites = [];

       function initMap() {
           var location = {lat: 33.7833, lng: -84.3831};
           map = new google.maps.Map(document.getElementById('map'), {
               zoom: 14,
               center: location
           });

           infoWindow = new google.maps.InfoWindow();
           service = new google.maps.places.PlacesService(map);

           if (navigator.geolocation) {
               navigator.geolocation.getCurrentPosition(function(position) {
                   var pos = {
                       lat: position.coords.latitude,
                       lng: position.coords.longitude
                   };

                   map.setCenter(pos);
                   fetchNearbyRestaurants(pos);
               }, function() {
                   handleLocationError(true, infoWindow, map.getCenter());
               });
           } else {
               handleLocationError(false, infoWindow, map.getCenter());
           }

           document.getElementById('search-input').addEventListener('keypress', function(e) {
               if (e.key === 'Enter') {
                   searchRestaurants(e.target.value);
               }
           });

           loadFavorites();
       }

       function handleLocationError(browserHasGeolocation, infoWindow, pos) {
           infoWindow.setPosition(pos);
           infoWindow.setContent(browserHasGeolocation ?
               'Error: The Geolocation service failed.' :
               'Error: Your browser doesn\'t support geolocation.');
           infoWindow.open(map);
       }

       function fetchNearbyRestaurants(location) {
           clearMarkers();
           service.nearbySearch({
               location: location,
               radius: 1500,
               type: ['restaurant']
           }, function(results, status) {
               if (status === google.maps.places.PlacesServiceStatus.OK) {
                   for (var i = 0; i < results.length; i++) {
                       createMarker(results[i]);
                   }
                   populateRestaurantCards(results);
               }
           });
       }

       function searchRestaurants(query) {
           clearMarkers();
           service.textSearch({
               query: query + ' restaurants',
               bounds: map.getBounds()
           }, function(results, status) {
               if (status === google.maps.places.PlacesServiceStatus.OK) {
                   for (var i = 0; i < results.length; i++) {
                       createMarker(results[i]);
                   }
                   populateRestaurantCards(results);
               }
           });
       }

       function createMarker(place) {
           var marker = new google.maps.Marker({
               map: map,
               position: place.geometry.location,
               title: place.name
           });

           markers.push(marker);

           google.maps.event.addListener(marker, 'click', function() {
               getPlaceDetails(place, function(placeDetails) {
                   showPopup(placeDetails);
               });
           });
       }

       function clearMarkers() {
           markers.forEach(marker => marker.setMap(null));
           markers = [];
       }

       function populateRestaurantCards(results) {
           const restaurantList = document.getElementById('restaurant-list');
           const template = document.getElementById('restaurant-card-template');

           restaurantList.innerHTML = '';

           results.forEach(place => {
               const card = template.content.cloneNode(true);
               const cardElement = card.querySelector('.restaurant-card');
               cardElement.setAttribute('data-place-id', place.place_id);
               cardElement.querySelector('.restaurant-name').textContent = place.name;
               cardElement.querySelector('.restaurant-rating').textContent = `${place.rating || 'N/A'} ★`;
               cardElement.querySelector('.restaurant-address').textContent = place.vicinity || place.formatted_address;
               cardElement.querySelector('.restaurant-description').textContent = place.types ? place.types.join(', ') : '';
               cardElement.querySelector('img').src = place.photos && place.photos.length > 0 ? place.photos[0].getUrl() : '/api/placeholder/80/80';

               cardElement.addEventListener('click', function() {
                   getPlaceDetails(place, function(placeDetails) {
                       showPopup(placeDetails);
                   });
               });

               restaurantList.appendChild(card);
           });
       }

       function getPlaceDetails(place, callback) {
           service.getDetails({ placeId: place.place_id }, function(placeDetails, status) {
               if (status === google.maps.places.PlacesServiceStatus.OK) {
                   callback(placeDetails);
               }
           });
       }

       function showPopup(place) {
           const popup = document.getElementById('popup');
           const isFavorite = favorites.some(fav => fav.id === place.place_id);
           popup.innerHTML = `
               <span class="popup-close" onclick="closePopup()">×</span>
               <div class="popup-content">
                   <h2>${place.name}</h2>
                   <p><strong>Address:</strong> ${place.formatted_address || 'No address available'}</p>
                   <p><strong>Phone:</strong> ${place.formatted_phone_number || 'No phone number available'}</p>
                   <p><strong>Rating:</strong> ${place.rating || 'N/A'} / 5</p>
                   <p><strong>Cuisine:</strong> ${place.types ? place.types.join(', ') : 'N/A'}</p>
                   <p><a href="${place.url}" target="_blank">View on Google Maps</a></p>
                   ${isFavorite ?
                       `<button onclick="removeFavorite('${place.place_id}')">Remove from Favorites</button>` :
                       `<button onclick="addFavorite('${place.place_id}', '${place.name}')">Add to Favorites</button>`
                   }
               </div>
           `;
           popup.style.display = 'block';

           // Add click event to the entire popup content
           popup.querySelector('.popup-content').addEventListener('click', function() {
               highlightCard(place.place_id);
           });
       }

       function closePopup() {
           document.getElementById('popup').style.display = 'none';
       }

       function highlightCard(placeId) {
           const cards = document.querySelectorAll('.restaurant-card');
           let targetCard = null;

           cards.forEach(card => {
               if (card.getAttribute('data-place-id') === placeId) {
                   targetCard = card;
                   card.classList.add('highlighted-card');
               } else {
                   card.classList.remove('highlighted-card');
               }
           });

           if (targetCard) {
               const parent = targetCard.parentNode;
               parent.insertBefore(targetCard, parent.firstChild);

               setTimeout(() => {
                   targetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
               }, 100);
           }

           closePopup();
       }

       function addFavorite(restaurantId, restaurantName) {
           if (!favorites.some(fav => fav.id === restaurantId)) {
               favorites.push({ id: restaurantId, name: restaurantName });
               updateFavoritesUI();
               saveFavorites();
           }

           fetch('/api/favorites/add/', {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json',
                   'X-CSRFToken': getCookie('csrftoken')
               },
               body: JSON.stringify({ restaurant_id: restaurantId })
           })
           .then(response => response.json())
           .then(data => {
               console.log(data.message);
           })
           .catch(error => {
               console.error('Error adding favorite:', error);
           });
       }

       function removeFavorite(restaurantId) {
           favorites = favorites.filter(fav => fav.id !== restaurantId);
           updateFavoritesUI();
           saveFavorites();

           fetch(`/api/favorites/remove/${restaurantId}/`, {
               method: 'DELETE',
               headers: {
                   'X-CSRFToken': getCookie('csrftoken')
               }
           })
           .then(response => response.json())
           .then(data => {
               console.log(data.message);
           })
           .catch(error => {
               console.error('Error removing favorite:', error);
           });
       }

       function saveFavorites() {
           localStorage.setItem('favorites', JSON.stringify(favorites));
       }

       function loadFavorites() {
           const savedFavorites = localStorage.getItem('favorites');
           if (savedFavorites) {
               favorites = JSON.parse(savedFavorites);
           } else {
               favorites = [];
           }
           updateFavoritesUI();
       }

       function updateFavoritesUI() {
           const favoritesContainer = document.getElementById('favorites');
           favoritesContainer.innerHTML = '';

           if (favorites.length === 0) {
               favoritesContainer.innerHTML = '<li>No favorites added.</li>';
               return;
           }

           favorites.forEach(fav => {
               const listItem = document.createElement('li');
               listItem.textContent = fav.name;
               favoritesContainer.appendChild(listItem);
           });
       }

       function getCookie(name) {
           let cookieValue = null;
           if (document.cookie && document.cookie !== '') {
               const cookies = document.cookie.split(';');
               for (let i = 0; i < cookies.length; i++) {
                   const cookie = cookies[i].trim();
                   if (cookie.substring(0, name.length + 1) === (name + '=')) {
                       cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                       break;
                   }
               }
           }
           return cookieValue;
       }
   </script>
</head>
<body onload="initMap()">
<header class="header">
    <h1>Restaurant Finder</h1>
    <div class="user-greeting">
        <span>Hello, {{ fname }}</span>
    </div>
    <div class="user-controls">
        <a href="{% url 'account' %}" class="account-button">View my Profile</a>
        <a href="{% url 'logout' %}" class="logout-button">Log Out</a>
    </div>
</header>

<div class="container">
    <div id="map"></div>
    <div class="search-panel">
        <input type="text" id="search-input" class="search-input" placeholder="Search for restaurants...">
        <div id="restaurant-list"></div>
        <h2>Your Favorites:</h2>
        <ul id="favorites"></ul>
    </div>
</div>

<template id="restaurant-card-template">
    <div class="restaurant-card">
        <img src="" alt="Restaurant Image">
        <div class="restaurant-name"></div>
        <div class="restaurant-rating"></div>
        <div class="restaurant-address"></div>
        <div class="restaurant-description"></div>
    </div>
</template>

<div id="popup" class="popup"></div>

</body>
</html>